{% extends "base.html" %}
{% block content %}

<div class="page-header">
  <div>
    <h1 class="page-title">Ticket System</h1>
    <p class="page-desc">パネルごとに設定。フォーラム(入力) / ルール を独立してON/OFFできます。</p>
  </div>

  <div class="header-actions">
    <button class="btn" onclick="ticketAddPanel('{{ guild.id }}')">＋ パネル追加</button>
    <button id="ticket_save_btn" class="btn primary" onclick="ticketSave('{{ guild.id }}')">保存</button>
    <button id="ticket_deploy_btn" class="btn" onclick="ticketDeploy('{{ guild.id }}')">Discordに設置</button>
  </div>
</div>

<div class="glass-card">
  <div class="panel-row">
    <div class="field" style="flex:1;">
      <label>編集するパネル</label>
      <div class="select-wrap">
        <select id="ticket_panel_select" class="select" onchange="ticketSwitchPanel('{{ guild.id }}')">
          {% for p in panels %}
            <option value="{{ loop.index0 }}" {% if loop.index0 == panel_index %}selected{% endif %}>
              {{ loop.index0 }} : {{ p.panel_name }}
            </option>
          {% endfor %}
        </select>
        <span class="chev">▾</span>
      </div>
    </div>

    <div class="field" style="width:160px;">
      <label>有効化</label>
      <label class="switch">
        <input id="ticket_panel_enabled" type="checkbox" {% if panel.enabled %}checked{% endif %}>
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <div class="subtabs">
    <a class="tab {% if tab=='form' %}active{% endif %}"
       href="/guild/{{ guild.id }}/settings/ticket?panel={{ panel_index }}&tab=form">フォーラム</a>
    <a class="tab {% if tab=='rules' %}active{% endif %}"
       href="/guild/{{ guild.id }}/settings/ticket?panel={{ panel_index }}&tab=rules">ルール</a>
  </div>
</div>

{% if tab == "form" %}
<div class="glass-card">
  <h3 class="section-title">フォーラム（入力項目）</h3>

  <div class="form-grid">
    <div class="field">
      <label>フォーラム入力を有効化</label>
      <label class="switch">
        <input id="ticket_forum_enabled" type="checkbox" {% if panel.form and panel.form.enabled %}checked{% endif %}>
        <span class="slider"></span>
      </label>
    </div>

    <div class="field">
      <label>作成方式</label>
      <div class="select-wrap">
        <select id="ticket_mode" class="select">
          <option value="channel" {% if panel.mode=='channel' %}selected{% endif %}>専用チャンネルを作成</option>
          <option value="thread" {% if panel.mode=='thread' %}selected{% endif %}>プライベートスレッドを作成</option>
        </select>
        <span class="chev">▾</span>
      </div>
    </div>

    <div class="field">
      <label>チャンネル名テンプレ</label>
      <input id="ticket_name_template" class="input" value="{{ panel.name_template }}">
      <div class="help">変数: {user} {user_id} {created_at} {count}</div>
    </div>

    <div class="field">
      <label>親カテゴリ（専用チャンネル時）</label>
      <div class="select-wrap">
        <select id="ticket_parent_category" class="select">
          <option value="">(未指定)</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if panel.parent_category_id|string == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
        <span class="chev">▾</span>
      </div>
    </div>

    <div class="field">
      <label>親チャンネル（スレッド時）</label>
      <div class="select-wrap">
        <select id="ticket_thread_parent" class="select">
          <option value="">(未指定)</option>
          {% for ch in channels %}
            <option value="{{ ch.id }}" {% if panel.thread_parent_channel_id|string == ch.id %}selected{% endif %}>#{{ ch.name }}</option>
          {% endfor %}
        </select>
        <span class="chev">▾</span>
      </div>
    </div>

    <div class="field">
      <label>STAFFロール（複数OK、カンマ区切りでID）</label>
      <input id="ticket_staff_roles" class="input" value="{{ panel.permissions.staff_role_ids | join(',') }}">
    </div>

    <div class="field">
      <label>同時に持てるチケット数</label>
      <input id="ticket_limit_max" type="number" class="input" min="1" value="{{ panel.limits.max_open_per_user }}">
    </div>

    <div class="field">
      <label>連続作成クールダウン（分）</label>
      <input id="ticket_limit_cd" type="number" class="input" min="0" value="{{ panel.limits.cooldown_minutes }}">
    </div>
  </div>

  <div class="divider"></div>

  <div class="row-between">
    <h3 class="section-title">入力項目（無制限）</h3>
    <button class="btn" onclick="ticketAddFormField()">＋ 項目を追加</button>
  </div>

  <div id="ticket_form_fields" class="repeater"></div>

  <div class="help">
    ・緊急度は聞きません（要件）<br>
    ・項目は自由に追加/削除できます（最初0件）。
  </div>
</div>

{% else %}
<div class="glass-card">
  <h3 class="section-title">ルール（Embed）</h3>

  <div class="form-grid">
    <div class="field">
      <label>ルール表示を有効化</label>
      <label class="switch">
        <input id="ticket_rules_enabled" type="checkbox" {% if panel.rules and panel.rules.enabled %}checked{% endif %}>
        <span class="slider"></span>
      </label>
    </div>

    <div class="field">
      <label>タイトル</label>
      <input id="ticket_rules_title" class="input" value="{{ (panel.rules.title if panel.rules and panel.rules.title else '📌ルール・注意事項') }}">
    </div>

    <div class="field" style="grid-column:1/-1;">
      <label>本文</label>
      <textarea id="ticket_rules_body" class="textarea" rows="8">{{ (panel.rules.body if panel.rules and panel.rules.body else '') }}</textarea>
      <div class="help">本文が空なら保存時にテンプレを自動挿入します。</div>
    </div>
  </div>

  <div class="divider"></div>

  <h3 class="section-title">権限制御（ルール投稿/コメント）</h3>

  <div class="form-grid">
    <div class="field">
      <label>@everyone メンション許可</label>
      <label class="switch">
        <input id="ticket_rules_allow_everyone" type="checkbox" {% if panel.rules and panel.rules.allow_everyone_mention %}checked{% endif %}>
        <span class="slider"></span>
      </label>
    </div>

    <div class="field">
      <label>許可ロール（カンマ区切りID）</label>
      <input id="ticket_rules_allowed_roles" class="input" value="{{ (panel.rules.allowed_role_ids | join(',') if panel.rules and panel.rules.allowed_role_ids else '') }}">
    </div>

    <div class="field">
      <label>条件</label>
      <div class="select-wrap">
        {% set pol = (panel.rules.policy if panel.rules and panel.rules.policy else 'staff_only') %}
        <select id="ticket_rules_policy" class="select">
          <option value="staff_only" {% if pol=='staff_only' %}selected{% endif %}>STAFFのみ投稿可</option>
          <option value="allowed_roles" {% if pol=='allowed_roles' %}selected{% endif %}>許可ロールのみ投稿可</option>
          <option value="staff_or_allowed" {% if pol=='staff_or_allowed' %}selected{% endif %}>STAFF または 許可ロール</option>
        </select>
        <span class="chev">▾</span>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="glass-card danger-zone">
  <h3 class="section-title">危険操作</h3>
  <p class="page-desc">このパネルを削除します。設置済みメッセージがあればそれも削除します。</p>
  <button class="btn danger" onclick="ticketDeletePanel('{{ guild.id }}')">このパネルを削除</button>
</div>

<!-- ✅ VSCode診断対策：JinjaをJSに混ぜず、JSONとして埋め込む -->
<script id="cfg-json" type="application/json">{{ cfg | tojson }}</script>
<script id="ticket-meta" type="application/json">
{"panel_index": {{ panel_index }}, "tab": "{{ tab }}"}
</script>

{% endblock %}
